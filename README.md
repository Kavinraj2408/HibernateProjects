WITH PARAMS AS (
    SELECT 
        20260 AS GARAGEID,
        TO_DATE('06/25/2024', 'MM/DD/YYYY') AS WORK_DATE,
        'CP' AS REGION 
    FROM dual
),
REPORTING_SUPV AS (
    SELECT DISTINCT 
        reports_to_userid,
        TO_CHAR(P.GARAGEID) AS SUPV_GARAGEID,
        0 AS LOANED_SUPERVISOR_FLAG 
    FROM 
        PARAMS P
        INNER JOIN RMDBA.EMP E ON E.ECFKGRGPK = P.GARAGEID AND E.ACTIVE_FLG = 'Y' AND E.DO_FLG = 'Y'
        INNER JOIN RMDBA.SITE_EMP SE ON SE.EMP_USERID = E.USERID AND SE.ROLE_NM = 'DOTECH' AND SE.DEFAULT_FLG = 'Y'
        INNER JOIN RMDBA.SITE ON SITE.ID = SE.SITE_ID AND SITE.SRC_NM = 'DO-' || P.REGION
),
LOANED_SUPV AS (
    SELECT DISTINCT 
        E.reports_to_userid,
        TO_CHAR(E.ECFKGRGPK) AS SUPV_GARAGEID,
        1 AS LOANED_SUPERVISOR_FLAG 
    FROM 
        PARAMS P
        INNER JOIN RMDBA.EC_LOAN ECL ON ECL.ECLOANFKGRGPK = P.GARAGEID AND ECL.ECLOANDATE = P.work_date
        INNER JOIN RMDBA.EMP E ON E.USERID = ECL.ECLOANUSERID AND E.ACTIVE_FLG = 'Y' AND E.DO_FLG = 'Y'
        INNER JOIN RMDBA.SITE_EMP SE ON SE.EMP_USERID = E.USERID AND SE.ROLE_NM = 'DOTECH' AND SE.DEFAULT_FLG = 'Y'
        INNER JOIN RMDBA.SITE ON SITE.ID = SE.SITE_ID AND SITE.SRC_NM = 'DO-' || P.REGION
        INNER JOIN RMDBA.SCHEDULE S ON S.EMP_USERID = E.USERID AND S.SCH_DT = TRUNC(SYSDATE)
        INNER JOIN RMDBA.ACTIVITY A ON A.CODE = PRIMARY_DUTY_CD AND A.PRODUCTIVE_FLG = 'Y'
        LEFT OUTER JOIN REPORTING_SUPV R ON R.reports_to_userid = E.reports_to_userid
    WHERE 
        R.reports_to_userid IS NULL
),
ALL_SUPV AS (
    SELECT * FROM REPORTING_SUPV
    UNION 
    SELECT * FROM LOANED_SUPV
),
FINAL_RESULT AS (
    SELECT 
        P.GARAGEID AS SUPV_GARAGEID,
                P.GARAGEID AS GARAGEID,
        A.LOANED_SUPERVISOR_FLAG,
        G.GRGNAME AS SUPV_GARAGE_NAME,
        UPPER(E.VZID) AS SUPV_VZID,
        E.USERID AS SUPV_USERID,
        E.FIRST_NM AS SUPERVISOR_FIRSTNAME,
        E.LAST_NM AS SUPERVISOR_LASTNAME 
    FROM 
        ALL_SUPV A
        INNER JOIN RMDBA.GARAGE G ON G.GRGPK = A.SUPV_GARAGEID
        INNER JOIN RMDBA.EMP E ON E.USERID = A.REPORTS_TO_USERID
        INNER JOIN PARAMS P ON 1 = 1
)
SELECT 
    F.*,
    H.CN AS SUPERVISOR_FULLNAME 
FROM 
    FINAL_RESULT F
    INNER JOIN RMDBA.HR_FEED H ON H.VZ_ID = LOWER(F.SUPV_VZID)
ORDER BY 
    SUPERVISOR_LASTNAME, SUPERVISOR_FIRSTNAME;
